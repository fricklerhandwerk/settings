#! /usr/bin/env nix-shell
#! nix-shell -i fish -p fish

set self (status current-filename)
set current (dirname (readlink --canonicalize-existing $self))

if not test -d $machines/$argv[1]
  echo "specify a machine:" >&2
  for i in (ls -d $machines/*/)
    echo (basename $i) >&2
  end
  exit 1
end

set cfg $current/machines/$machine

nix-shell -E \
"with import <nixpkgs> {}; mkShell { buildInputs = [ (callPackage $current/modules/home-manager.nix {}) ]; }" \
--run "home-manager -f $cfg switch"
